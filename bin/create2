#!/bin/bash

# Создаем репозиторий из существующего
# create2 clientname project hostnames clientname2 project2

echo "server {" | tee -a /home/nginx/$1
echo "  listen *:80;" | tee -a /home/nginx/$1
echo "  server_name $3;" | tee -a /home/nginx/$1
echo "  root /home/www/$1/$2;" | tee -a /home/nginx/$1
echo "  include /home/www/$1/$2/nginx.conf;" | tee -a /home/nginx/$1
echo "}" | tee -a /home/nginx/$1

cd /home/www/
mkdir $1
cd $1
mkdir $2
cd $2
cd ~
ln -s /home/www/$1/$2 $1-$2
cd /home/www/$1/$2
git init
git remote add origin git@bitbucket.org:betaagency/$4-$5.git
git pull origin master

sleep 200

git remote rm origin
echo "$3" > CNAME

# create remove rep on bitbucket behalf of betaagency team account
curl -X POST -u vedroid:x683TblHtz8HL3qbfOjw51POJhDNRA -H "Content-Type: application/json" \
  https://api.bitbucket.org/2.0/repositories/betaagency/$1-$2 \
    -d '{"scm": "git", "is_private": true}'

git add .
git commit -m 'autoadd CNAME file'
git remote add origin git@bitbucket.org:betaagency/$1-$2.git
git push origin master